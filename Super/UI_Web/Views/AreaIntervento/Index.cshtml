@{
    ViewBag.Title = "Area Intervento";
    Layout = "~/Content/Layout/Earthlingtwo/_Layout.cshtml";
}
<h2>
    Area Intervento</h2>
<div id="List" data-bind='template: "areaInterventoListTemplate"'>
</div>
<p>
    <a data-bind="click: GetItems" href="#">Visualizza</a> <a data-bind="click: AggiungereItem"
        href="#">Aggiungi Area Intervento</a>
</p>
<div id="details" style="overflow: hidden;">
</div>
<script type="text/html" id="areaInterventoListWaiting">
<br>
<br>
<center>
    <img src='@Url.Content("~/Images/ajax-loader.gif")'/><br>
    <i>Loading the data</i>
</center>
<br>
<br>
</script>
<script type="text/html" id="areaInterventoListTemplate">
    <table> 
            <tr>
                <th>
                    Descrizione
                </th>
                <th>
                    Inizio
                </th>
                <th>
                    Fine
                </th>
                <th>
                    CreationDate
                </th>
                <th colspan="2">
                    Azione
                </th>
            </tr>
        
         <% _.each(Items(), function(item) { %>
         <tr>
            
            <td>
                <%= item.Descrizione() %>
            </td>
            
            <td>
                <%= item.Inizio() %>
            </td>
            <td>
                <%= item.Fine() %>
            </td>
            <td>
                <%= item.CreationDate() %>
            </td>
             <td>
                <a data-bind="click: function() { viewModel.RedigereItem(item) }" href="#">Redigere</a>
            </td>
            <td>
                <a data-bind="click: function() { viewModel.TogliereItem(item) }" href="#">Togliere</a>
            </td>
        </tr>
         <% }) %>
        </table>
</script>
<script language="javascript">

    //Commands
    var CreareNuovoAreaIntervento = function (id, idAreaInterventoSuper, creationDate, inizio, fine, descrizione) {
        this.Id = id;
        this.IdAreaInterventoSuper = idAreaInterventoSuper;
        this.CreationDate = creationDate;
        this.Inizio = inizio;
        this.Fine = fine;
        this.Descrizione = descrizione;
    }
    var AggiornareAreaIntervento = function (id, idAreaInterventoSuper, inizio, fine, descrizione) {
        this.Id = id;
        this.IdAreaInterventoSuper = idAreaInterventoSuper;
        this.Inizio = inizio;
        this.Fine = fine;
        this.Descrizione = descrizione;
    }
    var CancellareAreaIntervento = function (id) {
        this.Id = id;
    }

    //Repository
    var Repository = function () {
        this.GetItems = function (success,error) {
            $.ajax({
                type: 'GET',
                url: '@Url.Action("GetItems")',
                context: this,
                success: success,
                error: error,
                dataType: 'json'
            });
        };
        this.Add = function (selected, success, error) {
            var returnValue = false;
            var command = new CreareNuovoAreaIntervento(selected.Id(), selected.IdAreaInterventoSuper(), selected.CreationDate(), selected.Inizio(), selected.Fine(), selected.Descrizione())
            $.ajax({
                type: 'Post',
                url: '@Url.Action("Creare")',
                data: JSON.stringify(command),
                contentType: 'application/json; charset=utf-8',
                success: function() { returnValue=success(selected)},
                error: function() { returnValue=error(selected)},
                dataType: 'json',
                async: false
            });
            return returnValue;
        };
        this.Update = function (selected, success, error) {
            var returnValue = false;
            var command = new AggiornareAreaIntervento(selected.Id(), selected.IdAreaInterventoSuper(), selected.Inizio(), selected.Fine(), selected.Descrizione())
            $.ajax({
                type: 'Post',
                url: '@Url.Action("Aggiornare")',
                data: JSON.stringify(command),
                contentType: 'application/json; charset=utf-8',
                success: function() { returnValue=success(selected)},
                error: function() { returnValue=error(selected)},
                dataType: 'json',
                async: false
            });
            return returnValue;
        };
        this.Delete = function (selected, success, error) {
            var returnValue = false;
            var command = new CancellareAreaIntervento(selected.Id())
            $.ajax({
                type: 'Post',
                url: '@Url.Action("Cancellare")',
                data: JSON.stringify(command),
                contentType: 'application/json; charset=utf-8',
                success: function() { returnValue=success(selected)},
                error: function() { returnValue=error(selected)},
                dataType: 'json',
                async: false
            });
            return returnValue;
        };
    }

    //Dialog
    var Dialog = function () {
        var self = this;

        this.OpenDialog = function (urlView, title) {
            self.UrlView = urlView;

            $('#details').dialog({
                autoOpen: false,
                width: 350,
                height: 400,
                position: 'center',
                resizable: true,
                title: title,
                modal: true,
                open: function (event, ui) {
                    $(this).load(self.UrlView, function () {
                        ko.applyBindings(viewModel, document.getElementById("details"));
                    });
                },
                buttons: {
                    "Accept": function () {
                        if (viewModel.Accept())
                            $(this).dialog("close");
                    },
                    "Cancel": function () {
                        viewModel.Cancel();
                        $(this).dialog("close");
                    }
                }
            });
            $("#details").dialog("open");  //let's put this in a custom binding handler called "openDialog"
        }

        this.Close = function () {
            $("#details").dialog("close");
        }
    }

    //Model
    var AreaIntervento = function (id, idAreaInterventoSuper, creationDate, inizio, fine, descrizione, isNew) {
        var self = this;
        this.Id = ko.observable(id);
        this.IdAreaInterventoSuper = ko.observable(idAreaInterventoSuper);
        this.CreationDate = ko.observable(creationDate.format("dd/mm/yyyy HH:MM"));
        this.Inizio = ko.observable(inizio.format("dd/mm/yyyy"));
        this.Fine = ko.observable(fine.format("dd/mm/yyyy"));
        this.Descrizione = ko.observable(descrizione);
        this.IsNew = isNew;

        this.EditIdAreaInterventoSuper = ko.observable(idAreaInterventoSuper);
        this.EditInizio = ko.observable(inizio.format("dd/mm/yyyy"));
        this.EditFine = ko.observable(fine.format("dd/mm/yyyy"));
        this.EditDescrizione = ko.observable(descrizione);

        //reset to originals on cancel 
        this.Cancel = function () {
            this.IdAreaInterventoSuper(this.EditIdAreaInterventoSuper()).Inizio(this.EditInizio()).Fine(this.EditFine()).Descrizione(this.EditDescrizione());
        } .bind(this);

        //persist edits to real values on accept
        this.Accept = function () {
            this.EditIdAreaInterventoSuper(this.IdAreaInterventoSuper()).EditInizio(this.Inizio()).EditFine(this.Fine()).EditDescrizione(this.Descrizione());
        } .bind(this);
    }



    //ViewModel
    var ViewModel = function (repository, dialog) {
        var self = this;
            
        this.Items = ko.mapping.fromJS([]);
        this.SelectedItem = ko.observable();

        
        this.GetItems = function () {
            $("#List").html($("#areaInterventoListWaiting").html());
            repository.GetItems(this.SuccessfullyRetrievedModelsFromAjax);
        };

        this.RedigereItem = function (item) {
            viewModel.SelectedItem(item);
            dialog.OpenDialog("@Url.Action("Aggiornare")",'Aggiornare un area Intervento');
        };
        this.AggiungereItem = function () {
            var now = new Date();
            var newItem = new AreaIntervento(guidGenerator(),0, now, now, now, '', true)
            viewModel.SelectedItem(newItem);
            dialog.OpenDialog("@Url.Action("Creare")",'Aggiungere un area Intervento');
        };
        this.TogliereItem = function (item) {
            repository.Delete(item);
            viewModel.Items.remove(item);
        };

        this.AcceptSuccess = function(selected){
            selected.Accept();
            if (selected.IsNew)            
                viewModel.Items.push(selected);
            viewModel.SelectedItem("");
            return true;
        }

        this.AcceptError = function(selected){
            return false;
        }

        this.Accept = function () {
            var returnValue = false;
            // Activate jQuery Validation
            if ($("#formDetails").validate())
            {
                var selected = viewModel.SelectedItem();

                if (selected.IsNew) 
                    returnValue = repository.Add(selected,viewModel.AcceptSuccess,viewModel.AcceptError);
                else
                    returnValue = repository.Update(selected,viewModel.AcceptSuccess,viewModel.AcceptError);
                return returnValue;
            }
        },
        this.Cancel = function () {
            viewModel.SelectedItem().Cancel();
            viewModel.SelectedItem("");
            dialog.Close();
        }

        this.SuccessfullyRetrievedModelsFromAjax = function (models) {
            self.Items.removeAll();
            ko.utils.arrayForEach(models, function (model) {
                self.Items.push(new AreaIntervento(model.Id,model.IdAreaInterventoSuper, ToDate(model.CreationDate), ToDate(model.Inizio), ToDate(model.Fine), model.Descrizione));
            });
        };
    };
    var viewModel = new ViewModel(new Repository(), new Dialog());
    ko.applyBindings(viewModel);

    

    viewModel.GetItems();

        
</script>
